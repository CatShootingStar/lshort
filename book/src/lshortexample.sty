\ProvidesExplPackage{lshortexample}{2022-05-02}{0.1}{
  Macros for typesetting examples in lshort book written in LaTeX3
}

\RequirePackage{changepage}
\RequirePackage{frame}
\RequirePackage{graphicx}
\RequirePackage{verbatim}
% L3 interface for verbatim
\cs_new_eq:NN \verbatim_start: \verbatim@start

\cs_new_protected:Nn \verbatim_set_processline:N {
  \tl_set:Nn \verbatim@processline {
    #1 {\the\verbatim@line}
  }
}

\cs_new_protected:Nn \verbatim_set_processline_inline:n {
  \cs_set_protected:Nn \__lshortexample_func_temp:n {#1}
  \verbatim_set_processline:N \__lshortexample_func_temp:n
}

\tl_new:N \__lshortexample_example_label
\int_new:N \__lshortexample_example_counter
\bool_new:N \__lshortexample_hide_switch
\bool_new:N \__lshortexample_show_switch

\keys_define:nn { lshortexample } {
  standalone .bool_set:N = \__lshortexample_standalone_bool,

  extend .bool_set:N = \__lshortexample_extend,
  noextend .bool_set_inverse:N = \__lshortexample_extend,
  extend .initial:n = true,

  cache .bool_set:N = \__lshortexample_cache_bool,
  nocache .bool_set_inverse:N = \__lshortexample_cache_bool,
  cache .initial:n = true,

  biber .bool_set:N = \__lshortexample_biber_run,
  biber_dir .tl_set:N = \__lshortexample_biber_dir,
  biber_dir .initial:n  = .,

  cache_dir .tl_set:N  = \__lshortexample_cache_dir_tl,
  cache_dir .initial:n  = example_cache/,

  template_dir .tl_set:N  = \__lshortexample_template_dir_tl,
  template_dir .initial:n  = ../src/templates/,

  template .tl_set:N  = \__lshortexample_template_tl,
  template .initial:n  = default,

  paperwidth .dim_set:N = \__lshortexample_paperwidth,
  paperwidth .initial:n = 5cm,

  paperheight .dim_set:N = \__lshortexample_paperheight,
  paperheight .initial:n = {\fp_to_dim:n {sqrt(2) * \__lshortexample_paperwidth}},

  examplewidth .tl_set:N = \__lshortexample_examplewidth,
  examplewidth .initial:n = 0.48\linewidth,

  verbatim_input_file_name .tl_set:N = \__lshortexample_verbatim_input_file,
  verbatim_input_file_name .initial:n = {\c_sys_jobname_str _input.exa},

  verbatim_output_file_name .tl_set:N = \__lshortexample_verbatim_output_file,
  verbatim_output_file_name .initial:n = {\c_sys_jobname_str _output.exa},

  from_page .int_set:N  = \__lshortexample_from_page,
  from_page .initial:n  = 1,

  to_page .int_set:N  = \__lshortexample_to_page,
  to_page .initial:n  = 1,

  vertical_pages .bool_set:N = \__lshortexample_vertical_pages_bool,
  vertical_pages .initial:n = false,
}

\NewDocumentEnvironment{example}{!o} {
  \group_begin:
  \IfValueT {#1} {
    \keys_set:nn { lshortexample } { #1 }
  }

  \iow_open:Nn \g_tmpa_iow {\__lshortexample_verbatim_input_file}
  \iow_open:Nn \g_tmpb_iow {\__lshortexample_verbatim_output_file}
  \seq_map_inline:Nn \l_char_special_seq {\char_set_catcode_other:N ##1}
  \char_set_catcode_active:N \^^M
  \verbatim_set_processline:N \lshortexample_verbatim_processline:n
  \verbatim_start:
} {
  \iow_close:N \g_tmpa_iow
  \iow_close:N \g_tmpb_iow
  \group_end:

  \begin{trivlist}
    \item\relax
    \group_begin:
    \IfValueT {#1} {
      \keys_set:nn { lshortexample } { #1 }
    }

    \tl_set:Nx \__lshortexample_example_label {example@\int_use:N\__lshortexample_example_counter}

    \bool_if:NTF \__lshortexample_extend {
      \int_if_odd:nTF {\getpagerefnumber{\__lshortexample_example_label}} {
        \dim_set:Nn \l_tmpa_dim {0pt}
        \dim_set:Nn \l_tmpb_dim {-1cm}
      } {
        \dim_set:Nn \l_tmpa_dim {-1cm}
        \dim_set:Nn \l_tmpb_dim {0pt}
      }
    } {
      \dim_set:Nn \l_tmpa_dim {0pt}
      \dim_set:Nn \l_tmpb_dim {0pt}
    }

    \begin{adjustwidth}{\l_tmpa_dim}{\l_tmpb_dim}
      \bool_if:NTF \__lshortexample_standalone_bool {
        \lshortexample_typeset_standalone_example:nn {
          \__lshortexample_verbatim_input_file
        } {
          \__lshortexample_verbatim_output_file
        }
      } {
        \lshortexample_typeset_example:nn {
          \__lshortexample_verbatim_input_file
        } {
          \__lshortexample_verbatim_output_file
        }
      }
      \label{\__lshortexample_example_label}
    \end{adjustwidth}
    \int_gincr:N \__lshortexample_example_counter
    \group_end:
  \end{trivlist}
}

\cs_new:Nn \lshortexample_compile_command:nnn {
  xelatex~
  --output-directory=\__lshortexample_cache_dir_tl\c_space_tl
  -interaction=nonstopmode\c_space_tl
  --jobname=#1~'
  \c_backslash_str def\c_backslash_str file{#2}
  \c_backslash_str newlength{\c_backslash_str width}
  \c_backslash_str setlength{\c_backslash_str width}{\dim_use:N \__lshortexample_paperwidth}
  \c_backslash_str newlength{\c_backslash_str height}
  \c_backslash_str setlength{\c_backslash_str height}{\dim_use:N \__lshortexample_paperheight}
  \c_backslash_str input{#3}
  '
}

\cs_new:Nn \lshortexample_compile_example:nn {
  \sys_shell_now:x {
    mkdir~-p~\__lshortexample_cache_dir_tl;
    \lshortexample_compile_command:nnn {#2} {#1} {
      \__lshortexample_template_dir_tl\__lshortexample_template_tl.tex
    };
    \lshortexample_compile_command:nnn {#2} {#1} {
      \__lshortexample_template_dir_tl\__lshortexample_template_tl.tex
    }
  }
}

\cs_new:Nn \lshortexample_compile_biber_example:nn {
  \sys_shell_now:x {
    mkdir~-p~\__lshortexample_cache_dir_tl;
    \lshortexample_compile_command:nnn {#2} {#1} {
      \__lshortexample_template_dir_tl\__lshortexample_template_tl.tex
    };
    biber~--input-directory~\__lshortexample_biber_dir~\c_space_tl~\__lshortexample_cache_dir_tl #2;
    \lshortexample_compile_command:nnn {#2} {#1} {
      \__lshortexample_template_dir_tl\__lshortexample_template_tl.tex
    };
    \lshortexample_compile_command:nnn {#2} {#1} {
      \__lshortexample_template_dir_tl\__lshortexample_template_tl.tex
    }
  }
}

\cs_new:Nn \lshortexample_typeset_standalone_example:nn {
  \group_begin:
  \tl_set:Nn \l_tmpb_tl {\file_mdfive_hash:n {#1}}
  \dim_set:Nn \l_tmpa_dim {
    \bool_if:NTF \__lshortexample_vertical_pages_bool {
      \__lshortexample_paperwidth + 0.2pt
    } {
      (\__lshortexample_paperwidth + 0.2pt) * (
      \__lshortexample_to_page - \__lshortexample_from_page + 1)
    }
  }
  \begin{minipage}{\dim_eval:n {\linewidth - \l_tmpa_dim}}
    \small\verbatiminput{#2}
  \end{minipage}
  \file_if_exist:nTF {\__lshortexample_cache_dir_tl\l_tmpb_tl.pdf} {
    \bool_set:Nn \l_tmpa_bool {\c_false_bool}
  }{
    \bool_set:Nn \l_tmpa_bool {\c_true_bool}
  }
  \bool_if:nT {
    !\__lshortexample_cache_bool || \l_tmpa_bool
  } {
    \bool_if:NTF \__lshortexample_biber_run {
      \lshortexample_compile_biber_example:nn {#1} {\l_tmpb_tl}
    } {
      \lshortexample_compile_example:nn {#1} {\l_tmpb_tl}
    }
  }
  \begin{minipage}{\l_tmpa_dim}
    \int_step_inline:nnn {\__lshortexample_from_page} {\__lshortexample_to_page} {
      \fancyframebox{0.1pt}{0pt}{
        \includegraphics[
          width=\__lshortexample_paperwidth,
          page=##1]{
          \__lshortexample_cache_dir_tl\l_tmpb_tl
        }
      }
      \bool_if:nT {
        \__lshortexample_vertical_pages_bool &&
        !\int_compare_p:nNn {##1} = {\__lshortexample_to_page}
      } {\\[-1pt]}
    }
  \end{minipage}
  \group_end:
}

\cs_new:Nn \lshortexample_typeset_example:nn {
  \begin{minipage}{\linewidth-\__lshortexample_examplewidth-0.2pt-6mm}
    \small\verbatiminput{#2}
  \end{minipage}
  \fancyframebox{0.1pt}{3mm}{
    \begin{minipage}{\__lshortexample_examplewidth}
      \input{#1}
    \end{minipage}
  }
}

\cs_new:Nn \lshortexample_verbatim_processline:n {

  \exp_args:Nx \str_if_in:nnT {#1} {!showbegin} {
    \bool_set:Nn \__lshortexample_show_switch {\c_true_bool}
  }
  \exp_args:Nx \str_if_in:nnT {#1} {!showend} {
    \bool_set:Nn \__lshortexample_show_switch {\c_false_bool}
  }

  \bool_if:NF \__lshortexample_show_switch {
    \exp_args:Nx \str_if_in:nnF {#1} {!show} {
      \iow_now:Nx \g_tmpa_iow {#1}
    }
  }

  \exp_args:Nx \str_if_in:nnT {#1} {!hidebegin} {
    \bool_set:Nn \__lshortexample_hide_switch {\c_true_bool}
  }
  \exp_args:Nx \str_if_in:nnT {#1} {!hideend} {
    \bool_set:Nn \__lshortexample_hide_switch {\c_false_bool}
  }

  \bool_if:NF \__lshortexample_hide_switch {
    \exp_args:Nx \str_if_in:nnF {#1} {!hide} {
      \iow_now:Nx \g_tmpb_iow {#1}
    }
  }
}
